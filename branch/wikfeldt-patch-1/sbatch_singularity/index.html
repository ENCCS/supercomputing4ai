<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Queueing jobs and running a Singularity container &mdash; Supercomputing for AI  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_lesson.css?v=0c089442" />
      <link rel="stylesheet" type="text/css" href="../_static/term_role_formatting.css?v=4194e21c" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_rtd_theme_ext_color_contrast.css?v=8e8ea19f" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />
      <link rel="stylesheet" type="text/css" href="../_static/overrides.css?v=0572569b" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=187304be"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script src="../_static/minipres.js?v=a0d29692"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Quick Reference" href="../quick-reference/" />
    <link rel="prev" title="Available software and modules" href="../software_modules/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            Supercomputing for AI
              <img src="../_static/ENCCS.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../supercomputer_why/">What is a supercomputer and how is it different from cloud?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connect_to_cluster/">Connecting to a HPC resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../folders_and_transfer/">Move between folders, ls, transferring to/from local storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software_modules/">Available software and modules</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Queueing jobs and running a Singularity container</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">Supercomputing for AI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Queueing jobs and running a Singularity container</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ENCCS/content/blob/main/content/sbatch_singularity.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="queueing-jobs-and-running-a-singularity-container">
<h1>Queueing jobs and running a Singularity container<a class="headerlink" href="#queueing-jobs-and-running-a-singularity-container" title="Link to this heading"></a></h1>
<p>Most supercomputers use a system called <a class="reference external" href="https://slurm.schedmd.com/documentation.html">SLURM</a> to manage jobs and maximise cluster utilisation.
There are two main workflows:</p>
<ul class="simple">
<li><p>Interactive mode, in which the user asks for resources, logs into the compute nodes and runs all they need to run</p></li>
<li><p>Batch mode, in which the user prepares a <code class="docutils literal notranslate"><span class="pre">submit</span></code> script (usually Bash) that contains all the instructions to be executed. The script is then placed in the queue and runs without any further inputs.</p></li>
</ul>
<p>Interactive resources can be requested with the <code class="docutils literal notranslate"><span class="pre">salloc</span></code> command in the following fashion:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>salloc<span class="w"> </span>-n<span class="w"> </span>&lt;n_cores&gt;<span class="w"> </span>-t<span class="w"> </span>HH:MM:SS<span class="w"> </span>-A<span class="w"> </span>&lt;allocation_number&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;partition&gt;
</pre></div>
</div>
<p>Most parameters are self-explanatory. <code class="docutils literal notranslate"><span class="pre">-t</span></code> is the wall time, <code class="docutils literal notranslate"><span class="pre">-A</span></code> is an allocation dependent on the project. <code class="docutils literal notranslate"><span class="pre">-p</span></code> is required by some clusters that have different types of nodes, e.g. Dardel has
a set of nodes reserved for interactive use on a partition called <code class="docutils literal notranslate"><span class="pre">shared</span></code> and a set of nodes with GPUs (<code class="docutils literal notranslate"><span class="pre">gpu</span></code>). There are many other options that are explained <a class="reference external" href="https://slurm.schedmd.com/salloc.html">here</a>.
Once the requested resources are granted, a MPI job can be executed with <code class="docutils literal notranslate"><span class="pre">srun</span> <span class="pre">-n</span> <span class="pre">&lt;n_cores&gt;</span> <span class="pre">my_command</span></code>; alternatively, the user can also ssh directly into the allocated node.</p>
<div class="admonition-type-along type-along important admonition" id="type-along-0">
<p class="admonition-title">Type-Along</p>
<p>Let’s book a node with a GPU to run our script:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>salloc<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-t<span class="w"> </span><span class="m">00</span>:50:00<span class="w"> </span>-A<span class="w"> </span>pdc-bus-2024-8<span class="w"> </span>-p<span class="w"> </span>gpu<span class="w"> </span>--gpus<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Once we get our node, we can train our model:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>singularity<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--rocm<span class="w"> </span>-B<span class="w"> </span>./models:/models<span class="w"> </span>/cfs/klemming/projects/supr/bustestingshared/ENCCS/rocm_tensorflow/<span class="w"> </span>python<span class="w"> </span>models/unet/main.py
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">-B</span></code> flag is used to bind a directory on the filesystem to a directory in the container and the <code class="docutils literal notranslate"><span class="pre">--rocm</span></code> flag is used to expose the GPU to
the container. The <code class="docutils literal notranslate"><span class="pre">rocm_tensorflow</span></code> folder contains a pre-built container with the necessary Python packages. If the ImageMagick module was loaded, we
can inspect a the accuracy and losses in the <code class="docutils literal notranslate"><span class="pre">results/training</span></code> folder with the <code class="docutils literal notranslate"><span class="pre">display</span></code> command.
Once the network is trained, we can perform inference:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>srun<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>singularity<span class="w"> </span>--exec<span class="w"> </span>--rocm<span class="w"> </span>-B<span class="w"> </span>./models:/models,./images:/images<span class="w"> </span>/cfs/klemming/projects/supr/bustestingshared/ENCCS/rocm_tensorflow<span class="w"> </span>python<span class="w"> </span>models/serving/main.py<span class="w"> </span>-f<span class="w"> </span>water_body_17.jpg
</pre></div>
</div>
<p>The image and generated mask can be shown with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>display<span class="w"> </span>images/water_body_17.jpg
<span class="gp">$ </span>display<span class="w"> </span>images/generated-images/water_body_17.jpg
</pre></div>
</div>
<p>Alternatively, you can open another local terminal (i.e. on your computer) and copy the images back for local visualisation:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">scp -r &lt;yourusername&gt;@dardel.pdc.kth.se:/cfs/klemming/projects/supr/bustestingshared/&lt;yourname&gt;/supercomputing4ai_demo/images /local/path</span>
</pre></div>
</div>
</div>
<div class="admonition-bonus-batch-mode-job type-along important admonition" id="type-along-1">
<p class="admonition-title">Bonus - Batch mode job</p>
<p>It is often easier to submit a job to the general queue rather than waiting for an interactive resource. As an example, we can book two nodes and print
their host name. Let’s create the following submission script and call it <cite>submit_test.sh</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -l</span>
<span class="c1">#SBATCH -J test # Job name</span>
<span class="c1">#SBATCH -t 00:02:00 # Wall time</span>
<span class="c1">#SBATCH -A pdc-bus-2024-8 # Allocation number</span>
<span class="c1">#SBATCH -p main # Partition - in this case the normal (non-GPU) is fine</span>
<span class="c1">#SBATCH --nodes 2 # We want two different nodes</span>
<span class="c1">#SBATCH --ntasks-per-node=1 # We want to book only one core on each node - We need just the hostname after all :)</span>
<span class="c1">#SBATCH --mail-type=ALL # Get an email when the job starts and when the job ends</span>

<span class="c1"># Now for the actual instruction to be executed</span>
srun<span class="w"> </span>hostname<span class="w"> </span>&gt;<span class="w"> </span>out.txt<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="c1"># Black magic to redirect both stdout and stderr to the same file</span>
</pre></div>
</div>
<p>We can now submit our short job to the queue:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sbatch<span class="w"> </span>submit.sh
</pre></div>
</div>
<p>We can check the status in queue with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>squeue<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../software_modules/" class="btn btn-neutral float-left" title="Available software and modules" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../quick-reference/" class="btn btn-neutral float-right" title="Quick Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, The contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>